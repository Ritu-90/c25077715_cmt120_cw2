{% extends 'base.html' %}
{% block content %}

<div class="text-center mb-5">
    <h2 class="fw-bold text-primary mb-4 text-center">Contact</h2>
    <p class="text-muted">
        Feel free to reach out for collaboration, opportunities, or any inquiries.<br>
        I’m always open to professional discussions and meaningful connections.<br>
        ✉️ <strong>Email:</strong> ritusikdermomo9901@gmail.com
    </p>
</div>

<div class="card mb-4">
    <div class="card-body">
        <form method="POST">
            {{ form.hidden_tag() }}
            {# Show Name field only for guests (logged-in users use account name automatically) #}
            {% if not current_user %}
              {{ form.name(class="form-control mb-2", placeholder="Your name") }}
            {% endif %}
            {{ form.message(class="form-control mb-2", placeholder="Message") }}
            {{ form.submit(class="btn btn-primary") }}
        </form>

        {% if current_user %}
          <small class="text-muted d-block mt-2">
            Your message will be posted as: <strong>{{ current_user.full_name or current_user.username }}</strong>
            (@{{ current_user.username }})
          </small>
        {% endif %}

    </div>
</div>

<!-- MESSAGES SECTION -->
<h5>Messages</h5>

{% for msg in comments %}
<div class="card mb-3">
    <div class="card-body">

        <strong>
          {% if msg.user %}
            {{ msg.user.full_name or msg.user.username }} (@{{ msg.user.username }})
          {% else %}
            {{ msg.name }}
          {% endif %}
        </strong>

        <p class="mb-2">{{ msg.message }}</p>

        <!-- ADMIN REPLY DISPLAY -->
        {% if msg.reply %}
            <div class="mt-2 p-2 bg-light border-start border-success">
                <strong>Reply:</strong>
                <p class="mb-0">{{ msg.reply }}</p>
            </div>
        {% endif %}

        {% if session.get('is_admin') %}
        <div class="mt-3">

            <!-- Buttons row -->
            <div class="d-flex gap-2 flex-wrap align-items-center">

                {% if not msg.reply %}
                    <!-- Reply is a GET link (correct) -->
                    <a href="{{ url_for('reply_message', msg_id=msg.id) }}"
                       class="btn btn-sm btn-outline-primary">
                        Reply
                    </a>
                {% else %}
                    <a href="{{ url_for('edit_reply', msg_id=msg.id) }}"
                       class="btn btn-sm btn-warning">
                        Edit Reply
                    </a>

                    <form action="{{ url_for('delete_reply', msg_id=msg.id) }}"
                          method="POST"
                          class="m-0">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit"
                                class="btn btn-sm btn-danger"
                                onclick="return confirm('Delete this reply?')">
                            Delete Reply
                        </button>
                    </form>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {# Owner/Admin edit/delete message #}
        {% if is_admin or (current_user and msg.user_id == current_user.id) %}
          <div class="mt-3">
            <div class="d-flex gap-2 flex-wrap align-items-center">

              <a href="{{ url_for('edit_message', msg_id=msg.id) }}"
                 class="btn btn-sm btn-outline-warning">
                Edit Message
              </a>

              <form action="{{ url_for('delete_message', msg_id=msg.id) }}"
                    method="POST"
                    class="m-0">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit"
                          class="btn btn-sm btn-outline-danger"
                          onclick="return confirm('Delete this message permanently?')">
                      Delete Message
                  </button>
              </form>

            </div>
          </div>
        {% endif %}

    </div>
</div>
{% else %}
<p class="text-muted">No messages yet.</p>
{% endfor %}

{% endblock %}
