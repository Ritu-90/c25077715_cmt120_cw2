{% extends "base.html" %}
{% block content %}
<div class="container py-4" style="max-width: 900px;">

  <h2 class="fw-bold">{{ project.title }}</h2>

  {% if project.image %}
    <img src="{{ url_for('static', filename='uploads/' ~ project.image) }}"
         class="img-fluid rounded mb-3" alt="Project image">
  {% endif %}

  {% if project.overview %}
    <p><strong>Overview:</strong> {{ project.overview }}</p>
  {% endif %}

  {% if project.link %}
    <p>
      <a href="{{ project.link }}" target="_blank" rel="noopener">Project Link</a>
    </p>
  {% endif %}

  <p>{{ project.description }}</p>

  <hr>

  <h4 class="mt-3">Rating</h4>

  {% if avg_rating is not none %}
    <div class="mb-2">
      {% set full_stars = avg_rating|int %}
      {% set empty_stars = 5 - full_stars %}

      <span style="font-size: 1.4rem; color: #f5c518;">
        {% for _ in range(full_stars) %}★{% endfor %}
        {% for _ in range(empty_stars) %}☆{% endfor %}
      </span>

      <span class="text-muted ms-2">
        {{ avg_rating }} / 5
      </span>
    </div>
  {% else %}
    <p class="text-muted">No ratings yet</p>
  {% endif %}

  {% if my_rating %}
    <p class="text-muted">
      Your rating: <strong>{{ my_rating }}</strong> / 5
    </p>
  {% endif %}

  <form method="POST" class="mb-4">
    {{ rating_form.hidden_tag() }}
    <input type="hidden" name="form_name" value="rating">

    {{ rating_form.rating(id="ratingInput", class="d-none") }}

    <div class="d-flex align-items-center gap-3">
      <div id="starRating" class="fs-3">
        <i class="bi bi-star-fill text-muted" data-star="1"></i>
        <i class="bi bi-star-fill text-muted" data-star="2"></i>
        <i class="bi bi-star-fill text-muted" data-star="3"></i>
        <i class="bi bi-star-fill text-muted" data-star="4"></i>
        <i class="bi bi-star-fill text-muted" data-star="5"></i>
      </div>

      <button class="btn btn-outline-primary" type="submit">
        {{ rating_form.submit.label.text }}
      </button>
    </div>

    <small class="text-muted d-block mt-2">
      Click stars to rate.
    </small>
  </form>

  <h4>Comments</h4>

  <form method="POST" class="mb-3">
    {{ comment_form.hidden_tag() }}
    <input type="hidden" name="form_name" value="comment">

    <div class="mb-2">
      {{ comment_form.text(class="form-control", rows=3, placeholder="Write a comment...") }}
    </div>
    <button class="btn btn-primary" type="submit">{{ comment_form.submit.label.text }}</button>

    {% if not current_user %}
      <small class="text-muted d-block mt-2">
        Login required to comment.
      </small>
    {% endif %}
  </form>

  {% for c in comments %}
    <div class="border rounded p-3 mb-2 bg-white shadow-sm">
      <div class="d-flex justify-content-between align-items-start gap-3">
        <div>
          <strong>
            {{ c.user.full_name or c.user.username }} (@{{ c.user.username }})
          </strong>
        </div>

        <div class="text-end">
          <small class="text-muted d-block">{{ c.created_at.strftime("%Y-%m-%d %H:%M") }}</small>

          {% if is_admin or (current_user and c.user_id == current_user.id) %}
            <div class="mt-2 d-flex gap-2 justify-content-end flex-wrap">
              <a class="btn btn-sm btn-outline-warning"
                 href="{{ url_for('edit_project_comment', comment_id=c.id) }}">
                Edit
              </a>

              <form method="POST"
                    action="{{ url_for('delete_project_comment', comment_id=c.id) }}"
                    class="m-0">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="submit"
                        class="btn btn-sm btn-outline-danger"
                        onclick="return confirm('Delete this comment?');">
                  Delete
                </button>
              </form>
            </div>
          {% endif %}
        </div>
      </div>

      <div class="mt-2">{{ c.text }}</div>
    </div>
  {% else %}
    <p class="text-muted">No comments yet.</p>
  {% endfor %}

</div>
{% endblock %}
